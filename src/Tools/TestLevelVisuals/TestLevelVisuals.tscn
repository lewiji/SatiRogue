[gd_scene load_steps=28 format=2]

[ext_resource path="res://scenes/res/EnvironmentEditor.tres" type="Environment" id=2]
[ext_resource path="res://resources/props/FloorPlane.tscn" type="PackedScene" id=3]
[ext_resource path="res://addons/MultiMeshBatcher/Batcher_Node.gd" type="Script" id=4]
[ext_resource path="res://assets/ui/GUI_set04_HUD_v1_0/atlas_all_n.png" type="Texture" id=5]
[ext_resource path="res://src/Tools/TestLevelVisuals/test_floor_plane.tres" type="PlaneMesh" id=7]
[ext_resource path="res://resources/level_material_sets/dungeon_0.tres" type="Resource" id=8]
[ext_resource path="res://src/Ecs/Dungeon/Nodes/Actors/Player.cs" type="Script" id=9]
[ext_resource path="res://resources/enemies/flash_overlay_shader.gdshader" type="Shader" id=10]
[ext_resource path="res://assets/ui/GUI_set04_HUD_v1_0/atlas_all_s.png" type="Texture" id=11]
[ext_resource path="res://assets/ui/GUI_set04_HUD_v1_0/atlas_all_o.png" type="Texture" id=12]
[ext_resource path="res://src/Ecs/Dungeon/Nodes/SpatialCamera.cs" type="Script" id=13]
[ext_resource path="res://scenes/ThreeDee/res/player/player_spatial_mat.tres" type="Material" id=14]
[ext_resource path="res://scenes/res/SpriteFramesPlayer.tres" type="SpriteFrames" id=15]
[ext_resource path="res://assets/ui/GUI_set04_HUD_v1_0/atlas_all.png" type="Texture" id=16]
[ext_resource path="res://src/Ecs/Dungeon/Nodes/Stairs.cs" type="Script" id=17]
[ext_resource path="res://src/Tools/TestLevelVisuals/test_stairs.tres" type="ArrayMesh" id=18]
[ext_resource path="res://src/Tools/TestLevelVisuals/test_floor_tile.tres" type="ArrayMesh" id=19]
[ext_resource path="res://src/Tools/TestLevelVisuals/test_walls.tres" type="ArrayMesh" id=20]

[sub_resource type="CSharpScript" id=7]
script/source = "using Godot;
using SatiRogue.Ecs.Dungeon.Nodes.Resources;

namespace SatiRogue.Debug; 

[Tool]
public class TestLevelVisuals : Spatial
{
    private Resource? _levelSet;
    [Export] private Resource? LevelSet {
        get => _levelSet;
        set {
            _levelSet = value;
            if (_levelSet is LevelMaterialSet levelSet) {
                ChangeMaterialSet(levelSet);
            } else {
                GD.Print($\"{_levelSet} was not a LevelMaterialSet.\");
            }
        }
    }
    
    public override void _Ready()
    {
        
    }

    void ChangeMaterialSet(LevelMaterialSet materialSet) {
        GD.Print(\"Changing material set\");
    }
}"

[sub_resource type="SpatialMaterial" id=1]
params_diffuse_mode = 4
params_specular_mode = 3
params_cull_mode = 1
params_use_alpha_scissor = true
params_alpha_scissor_threshold = 0.1
albedo_texture = ExtResource( 16 )
roughness = 0.5
roughness_texture = ExtResource( 11 )
emission_enabled = true
emission = Color( 0, 0, 0, 1 )
emission_energy = 0.03
emission_operator = 0
emission_on_uv2 = false
emission_texture = ExtResource( 16 )
normal_enabled = true
normal_scale = 1.0
normal_texture = ExtResource( 5 )
ao_enabled = true
ao_light_affect = 0.5
ao_texture = ExtResource( 12 )
ao_on_uv2 = false
ao_texture_channel = 0

[sub_resource type="MultiMesh" id=6]
transform_format = 1
instance_count = 25
mesh = ExtResource( 19 )
transform_array = PoolVector3Array( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, -1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 5 )

[sub_resource type="MultiMesh" id=2]
transform_format = 1
instance_count = 23
mesh = ExtResource( 20 )
transform_array = PoolVector3Array( 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 5, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 3.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 2.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 1.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 0.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -0.1, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -1.1, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 3.9, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 2.9, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 0.9, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -0.1, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -1.1, 0, -1 )

[sub_resource type="MultiMesh" id=8]
transform_format = 1
instance_count = 24
mesh = ExtResource( 19 )
transform_array = PoolVector3Array( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, 5 )

[sub_resource type="MultiMesh" id=9]
transform_format = 1
instance_count = 23
mesh = ExtResource( 20 )
transform_array = PoolVector3Array( 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 1.9, 0, -1, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, 5, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 3.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 2.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 1.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 0.9, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -0.1, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -1.1, 0, 6, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 3.9, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 2.9, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 0.9, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -0.1, 0, -1, -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, -1.1, 0, -1 )

[sub_resource type="MultiMesh" id=10]
transform_format = 1
instance_count = 15
mesh = ExtResource( 19 )
transform_array = PoolVector3Array( 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, -2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, -3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 5, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 6, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0, -3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0, -2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0, -1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 9, 0, -5 )

[sub_resource type="MultiMesh" id=11]
transform_format = 1
instance_count = 30
mesh = ExtResource( 20 )
transform_array = PoolVector3Array( 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, -2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, -2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, -3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, -3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, -5, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 2, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 3, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 5, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 6, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 9, 0, -6, 1, 0, 0, 0, 1, 0, 0, 0, 1, 4, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 5, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 6, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0, -4, 1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0, -3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0, -2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0, -1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 8, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 6, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 6, 0, -3, 1, 0, 0, 0, 1, 0, 0, 0, 1, 6, 0, -2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 6, 0, -1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 9, 0, -4 )

[sub_resource type="ShaderMaterial" id=5]
resource_local_to_scene = true
shader = ExtResource( 10 )
shader_param/albedo = Color( 1, 0, 0, 0 )
shader_param/specular = 0.5
shader_param/metallic = 0.0
shader_param/roughness = 1.0
shader_param/point_size = 1.0
shader_param/uv1_scale = Vector3( 1, 1, 1 )
shader_param/uv1_offset = Vector3( 0, 0, 0 )
shader_param/uv2_scale = Vector3( 1, 1, 1 )
shader_param/uv2_offset = Vector3( 0, 0, 0 )

[node name="TestLevelVisuals" type="Spatial"]
script = SubResource( 7 )
LevelSet = ExtResource( 8 )
FloorTileMesh = ExtResource( 19 )
WallMesh = ExtResource( 20 )
StairsMesh = ExtResource( 18 )

[node name="Environment" type="Spatial" parent="."]

[node name="WorldEnvironment" type="WorldEnvironment" parent="Environment"]
environment = ExtResource( 2 )

[node name="DirectionalLight" type="DirectionalLight" parent="Environment"]
transform = Transform( 0.862409, -0.0206019, 0.505793, -0.44509, 0.445094, 0.777037, -0.241134, -0.895247, 0.374684, 7.88736, 5.69369, 3.00922 )
light_energy = 0.618
shadow_enabled = true
shadow_color = Color( 0.498039, 0.498039, 0.498039, 1 )
shadow_bias = 0.02
directional_shadow_normal_bias = 0.1
directional_shadow_depth_range = 1
directional_shadow_max_distance = 32.0

[node name="FloorPlane" parent="Environment" instance=ExtResource( 3 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -1, 0 )
mesh = ExtResource( 7 )

[node name="LevelGeom" type="Spatial" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.954487, 0 )

[node name="Stairs" type="Spatial" parent="LevelGeom"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.840781, 0 )

[node name="Stairs2" type="Spatial" parent="LevelGeom/Stairs"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 12.1197, 0.853597, -5.84889 )
script = ExtResource( 17 )

[node name="MeshInstance" type="MeshInstance" parent="LevelGeom/Stairs/Stairs2"]
transform = Transform( -4.20181e-08, -1.20485e-08, 1, -0.275637, 0.961262, 0, -0.961262, -0.275637, -4.37114e-08, 0, -0.5, 0 )
mesh = ExtResource( 18 )

[node name="Sprite3D" type="Sprite3D" parent="LevelGeom/Stairs/Stairs2"]
transform = Transform( 1, 0, 0, 0, -4.37114e-08, -1, 0, 1, -4.37114e-08, 0, 0.006, 0 )
material_override = SubResource( 1 )
pixel_size = 0.03
texture = ExtResource( 16 )
region_enabled = true
region_rect = Rect2( 765, 1188, 38, 40 )

[node name="Room1" type="Spatial" parent="LevelGeom"]

[node name="Floor" type="MultiMeshInstance" parent="LevelGeom/Room1"]
multimesh = SubResource( 6 )
script = ExtResource( 4 )

[node name="Walls" type="MultiMeshInstance" parent="LevelGeom/Room1"]
multimesh = SubResource( 2 )
script = ExtResource( 4 )

[node name="Room2" type="Spatial" parent="LevelGeom"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 11, 0, -7 )

[node name="Floor" type="MultiMeshInstance" parent="LevelGeom/Room2"]
multimesh = SubResource( 8 )
script = ExtResource( 4 )

[node name="Walls" type="MultiMeshInstance" parent="LevelGeom/Room2"]
multimesh = SubResource( 9 )
script = ExtResource( 4 )

[node name="Corridor2" type="Spatial" parent="LevelGeom"]

[node name="Floor" type="MultiMeshInstance" parent="LevelGeom/Corridor2"]
multimesh = SubResource( 10 )
script = ExtResource( 4 )

[node name="Walls" type="MultiMeshInstance" parent="LevelGeom/Corridor2"]
multimesh = SubResource( 11 )
script = ExtResource( 4 )

[node name="Player" type="Spatial" parent="."]
physics_interpolation_mode = 2
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 7, -1.1, -3 )
script = ExtResource( 9 )

[node name="Visual" type="AnimatedSprite3D" parent="Player"]
transform = Transform( 1, 0, 0, 0, 0.939693, 0.34202, 0, -0.34202, 0.939693, 0, 0.75, 0 )
portal_mode = 2
material_override = ExtResource( 14 )
material_overlay = SubResource( 5 )
pixel_size = 0.05
shaded = true
double_sided = false
frames = ExtResource( 15 )
animation = "endwalk"
playing = true

[node name="Camera" type="Camera" parent="Player/Visual"]
transform = Transform( 1, 0, 0, 0, 0.78801, 0.615661, 0, -0.615661, 0.78801, 0, 4.23, 8 )
projection = 1
current = true
fov = 50.0
size = 16.0
script = ExtResource( 13 )

[node name="Light" type="SpotLight" parent="Player/Visual"]
transform = Transform( 0.966016, -0.0180308, 0.257852, -0.159137, 0.744604, 0.648259, -0.203687, -0.667262, 0.71643, 3.27, 2.95501, 8.99618 )
shadow_enabled = true
shadow_color = Color( 0.797333, 0.68, 1, 1 )
shadow_bias = 0.08
spot_range = 32.0
spot_attenuation = 0.618
spot_angle = 32.0
spot_angle_attenuation = 0.618

[node name="ReflectionProbe" type="ReflectionProbe" parent="Player"]
extents = Vector3( 8, 3, 11 )
origin_offset = Vector3( 0, 1.62, 0.62 )
box_projection = true
enable_shadows = true
interior_enable = true
interior_ambient_color = Color( 0.338, 0.026, 0.65, 1 )
interior_ambient_energy = 1.62
interior_ambient_contrib = 0.62
